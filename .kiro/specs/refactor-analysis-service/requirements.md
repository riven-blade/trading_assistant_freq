# 重构分析服务 - 需求文档

## 1. 项目概述

### 1.1 背景
当前系统中 Go 后端和 Python 分析服务通过数据库共享数据，但存在以下问题：
- Go 后端配置了 `ANALYSIS_SERVICE_URL` 但实际未使用
- Python 服务提供了 HTTP 接口但没有被调用
- 缺少自动化的分析触发机制

### 1.2 目标
重构分析服务，使其成为一个独立的定时任务服务：
- 移除 Go 后端中无用的 Python 服务 URL 配置
- 移除 Python 服务的 HTTP 接口
- 添加定时任务，每小时自动分析所有 USDT 交易对
- 保持 Go 后端读取分析结果的功能不变

## 2. 用户故事

### 2.1 作为系统管理员
**故事**: 我希望分析服务能够自动运行，无需手动触发
**价值**: 减少运维工作量，确保数据始终是最新的
**验收标准**:
- 分析服务启动后自动开始定时任务
- 每小时执行一次完整的市场分析
- 分析失败时有日志记录，不影响下次执行

### 2.2 作为交易员
**故事**: 我希望看到所有 USDT 交易对的支撑/压力位分析
**价值**: 帮助我做出更好的交易决策
**验收标准**:
- 系统自动分析所有 USDT 现货交易对
- 系统自动分析所有 USDT 期货交易对
- 分析结果包含 Top 5 支撑位和压力位
- 数据每小时更新一次

### 2.3 作为开发者
**故事**: 我希望代码库中没有无用的配置和代码
**价值**: 提高代码可维护性，减少混淆
**验收标准**:
- Go 后端中移除 ANALYSIS_SERVICE_URL 相关代码
- Python 服务中移除所有 HTTP 端点（除了健康检查）
- Docker 配置中移除不必要的端口映射
- 代码清晰，职责明确

## 3. 功能需求

### 3.1 Go 后端清理

#### FR-1.1 移除 ANALYSIS_SERVICE_URL 环境变量
**描述**: 从 Docker 配置和代码中移除 ANALYSIS_SERVICE_URL
**优先级**: 高
**验收标准**:
- [ ] docker-compose.yml 中移除 `ANALYSIS_SERVICE_URL` 环境变量
- [ ] 搜索代码库，确认没有使用该环境变量的代码
- [ ] 更新相关文档

#### FR-1.2 保持分析结果读取功能
**描述**: Go 后端继续提供读取分析结果的 API
**优先级**: 高
**验收标准**:
- [ ] `GET /api/v1/analysis/results` 正常工作
- [ ] `GET /api/v1/analysis/:id` 正常工作
- [ ] 前端页面正常显示分析结果

### 3.2 Python 服务重构

#### FR-2.1 移除 HTTP 接口
**描述**: 移除所有业务相关的 HTTP 端点，只保留健康检查
**优先级**: 高
**验收标准**:
- [ ] 移除 `POST /analyze` 端点
- [ ] 移除 `GET /results` 端点
- [ ] 保留 `GET /health` 端点用于容器健康检查
- [ ] 移除 FastAPI 的 API 文档相关配置

#### FR-2.2 实现定时任务调度器
**描述**: 添加定时任务，每小时执行一次市场分析
**优先级**: 高
**验收标准**:
- [ ] 使用 APScheduler 或类似库实现定时任务
- [ ] 任务间隔为 1 小时
- [ ] 服务启动时立即执行一次分析（可选）
- [ ] 任务执行时有清晰的日志输出

#### FR-2.3 获取交易所交易对列表
**描述**: 从 Binance 和 Bybit 交易所 API 获取所有 USDT 交易对
**优先级**: 高
**验收标准**:
- [ ] 支持 Binance 交易所
- [ ] 支持 Bybit 交易所
- [ ] 获取所有现货 USDT 交易对（如 BTC/USDT, ETH/USDT）
- [ ] 获取所有期货 USDT 交易对（如 BTC/USDT:USDT）
- [ ] 过滤掉非 USDT 质押物的交易对
- [ ] 处理交易所 API 限流和错误
- [ ] 每个交易所独立处理，互不影响

#### FR-2.4 批量分析交易对
**描述**: 对所有交易对进行支撑/压力位分析
**优先级**: 高
**验收标准**:
- [ ] 遍历所有交易对进行分析
- [ ] 每个交易对分析失败不影响其他交易对
- [ ] 使用合理的并发控制，避免触发交易所限流
- [ ] 分析结果写入数据库
- [ ] 记录分析成功/失败的统计信息

#### FR-2.5 数据库操作优化
**描述**: 优化数据库写入操作
**优先级**: 中
**验收标准**:
- [ ] 使用 upsert 操作（存在则更新，不存在则插入）
- [ ] 批量提交事务，提高性能
- [ ] 处理数据库连接异常

### 3.3 配置和部署

#### FR-3.1 更新 Docker 配置
**描述**: 更新 docker-compose.yml 配置
**优先级**: 高
**验收标准**:
- [ ] 移除 analysis-service 的端口映射（8000:8000）
- [ ] 移除 trading-assistant 的 ANALYSIS_SERVICE_URL 环境变量
- [ ] 保持 analysis-service 的健康检查配置
- [ ] 确保服务启动顺序正确（MySQL → analysis-service）

#### FR-3.2 添加配置选项
**描述**: 添加可配置的环境变量
**优先级**: 中
**验收标准**:
- [ ] `ANALYSIS_INTERVAL_HOURS`: 分析间隔（默认 1 小时）
- [ ] `ANALYSIS_EXCHANGES`: 交易所列表（默认 binance,bybit）
- [ ] `ANALYSIS_TIMEFRAMES`: 分析的时间周期（固定 1h,4h）
- [ ] `ANALYSIS_KLINE_LIMIT`: K线数量（固定 2000）
- [ ] `ANALYSIS_RUN_ON_STARTUP`: 启动时是否立即执行（默认 true）

## 4. 非功能需求

### 4.1 性能要求
- 单次完整分析（所有交易对）应在 30 分钟内完成
- 数据库查询响应时间 < 100ms
- 内存使用 < 2GB

### 4.2 可靠性要求
- 单个交易对分析失败不影响其他交易对
- 数据库连接失败时自动重试
- 交易所 API 限流时自动降速

### 4.3 可维护性要求
- 清晰的日志输出，包含时间戳和上下文信息
- 代码结构清晰，职责分离
- 配置项通过环境变量管理

### 4.4 可观测性要求
- 记录每次分析的统计信息（成功数、失败数、耗时）
- 记录异常和错误详情
- 提供健康检查端点

## 5. 技术约束

### 5.1 技术栈
- Python 3.12
- FastAPI（仅用于健康检查）
- APScheduler（定时任务）
- ccxt（交易所 API）
- SQLAlchemy（数据库 ORM）
- MySQL 8.0

### 5.2 依赖服务
- MySQL 数据库（必须先启动）
- 交易所 API（Binance 等）

### 5.3 兼容性
- 保持数据库 schema 不变
- 保持 Go 后端 API 接口不变
- 保持前端功能不变

## 6. 数据需求

### 6.1 交易对筛选规则
- **现货市场**: 
  - 格式: `BASE/USDT` (如 BTC/USDT, ETH/USDT)
  - 质押物: USDT
  - 状态: 活跃交易

- **期货市场**:
  - 格式: `BASE/USDT:USDT` (如 BTC/USDT:USDT)
  - 质押物: USDT
  - 类型: 永续合约或交割合约
  - 状态: 活跃交易

### 6.2 分析参数
- K 线数量: 2000 根（固定）
- 时间周期: 1h, 4h（固定）
- 支撑/压力位数量: Top 5
- 交易所: Binance, Bybit

### 6.3 数据存储
- 表名: `analysis_results`
- 唯一约束: (exchange, symbol, market_type, timeframe)
- 更新策略: 存在则更新，不存在则插入

## 7. 实施计划

### 7.1 阶段一：清理 Go 后端（1 小时）
1. 移除 docker-compose.yml 中的 ANALYSIS_SERVICE_URL
2. 搜索并确认 Go 代码中没有使用该变量
3. 测试 Go 后端功能正常

### 7.2 阶段二：重构 Python 服务（4 小时）
1. 移除 HTTP 业务端点，保留健康检查
2. 实现定时任务调度器
3. 实现交易对获取逻辑
4. 实现批量分析逻辑
5. 添加配置选项

### 7.3 阶段三：更新部署配置（1 小时）
1. 更新 docker-compose.yml
2. 更新 Dockerfile
3. 更新环境变量配置文件

### 7.4 阶段四：测试和验证（2 小时）
1. 单元测试
2. 集成测试
3. 性能测试
4. 端到端测试

## 8. 风险和缓解措施

### 8.1 风险：交易所 API 限流
**影响**: 分析任务无法完成
**缓解措施**:
- 添加请求间隔控制
- 实现指数退避重试
- 记录失败的交易对，下次优先处理

### 8.2 风险：数据库连接失败
**影响**: 分析结果无法保存
**缓解措施**:
- 实现数据库连接池
- 添加自动重连机制
- 记录失败的分析结果，稍后重试

### 8.3 风险：内存溢出
**影响**: 服务崩溃
**缓解措施**:
- 分批处理交易对
- 及时释放不用的数据
- 设置内存限制

### 8.4 风险：分析时间过长
**影响**: 下一次定时任务开始前未完成
**缓解措施**:
- 优化分析算法
- 减少 K 线数量（如果可接受）
- 增加并发处理（注意限流）

## 9. 验收标准总结

### 9.1 功能验收
- [ ] Python 服务启动后自动开始定时任务
- [ ] 每小时执行一次完整分析
- [ ] 所有 USDT 现货和期货交易对都被分析
- [ ] 分析结果正确写入数据库
- [ ] Go 后端 API 正常返回分析结果
- [ ] 前端页面正常显示分析数据

### 9.2 代码质量验收
- [ ] Go 后端中无 ANALYSIS_SERVICE_URL 相关代码
- [ ] Python 服务中无业务 HTTP 端点
- [ ] 代码有清晰的注释和文档
- [ ] 日志输出清晰易懂

### 9.3 性能验收
- [ ] 单次分析在 30 分钟内完成
- [ ] 内存使用稳定，无泄漏
- [ ] 数据库查询响应快速

### 9.4 可靠性验收
- [ ] 连续运行 24 小时无崩溃
- [ ] 单个交易对失败不影响整体
- [ ] 异常情况有完整日志

## 10. 后续优化建议

### 10.1 短期优化（1-2 周）
- 添加 Prometheus 监控指标
- 添加告警机制（分析失败率过高时告警）
- 优化并发处理，提高分析速度

### 10.2 中期优化（1-2 月）
- 支持更多交易所（OKX, MEXC 等）
- 添加更多分析指标（RSI, MACD 等）
- 实现智能调度（交易量大的优先分析）

### 10.3 长期优化（3-6 月）
- 使用机器学习优化支撑/压力位预测
- 添加回测功能，验证分析准确性
- 实现分布式分析，支持更大规模
