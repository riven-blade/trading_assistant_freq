# 重构分析服务 - 任务清单

## 1. Go 后端清理

### 1.1 移除 ANALYSIS_SERVICE_URL 配置
- [ ] 1.1.1 修改 `deploy/docker-compose.yml`，移除 `ANALYSIS_SERVICE_URL` 环境变量
- [ ] 1.1.2 搜索 Go 代码库，确认没有使用该环境变量
- [ ] 1.1.3 测试 Go 服务启动正常

## 2. Python 服务重构

### 2.1 创建配置管理模块
- [ ] 2.1.1 创建 `analysis_service/config.py`
- [ ] 2.1.2 实现 Config 类，包含所有配置项
- [ ] 2.1.3 添加环境变量读取逻辑
- [ ] 2.1.4 添加配置验证

### 2.2 创建交易对获取器
- [ ] 2.2.1 创建 `analysis_service/symbol_fetcher.py`
- [ ] 2.2.2 实现 `fetch_symbols()` 函数
  - [ ] 支持 Binance 现货
  - [ ] 支持 Binance 期货
  - [ ] 支持 Bybit 现货
  - [ ] 支持 Bybit 期货
- [ ] 2.2.3 实现 `is_usdt_pair()` 过滤函数
- [ ] 2.2.4 实现 `create_exchange()` 工厂函数
- [ ] 2.2.5 添加错误处理和重试逻辑
- [ ] 2.2.6 添加日志输出

### 2.3 创建数据库管理器
- [ ] 2.3.1 创建 `analysis_service/db_manager.py`
- [ ] 2.3.2 实现 `upsert_analysis_result()` 函数
- [ ] 2.3.3 实现批量提交逻辑
- [ ] 2.3.4 添加数据库连接池配置
- [ ] 2.3.5 添加错误处理

### 2.4 创建分析协调器
- [ ] 2.4.1 创建 `analysis_service/coordinator.py`
- [ ] 2.4.2 实现 `run_market_analysis()` 主函数
- [ ] 2.4.3 实现交易所遍历逻辑
- [ ] 2.4.4 实现市场类型遍历逻辑
- [ ] 2.4.5 实现时间周期遍历逻辑
- [ ] 2.4.6 实现 `analyze_symbol()` 单个交易对分析
- [ ] 2.4.7 添加并发控制（Semaphore）
- [ ] 2.4.8 实现统计信息收集
- [ ] 2.4.9 实现 `log_statistics()` 统计日志
- [ ] 2.4.10 添加错误处理，确保单点失败不影响整体

### 2.5 创建定时任务调度器
- [ ] 2.5.1 创建 `analysis_service/scheduler.py`
- [ ] 2.5.2 配置 APScheduler
- [ ] 2.5.3 实现 `start_scheduler()` 函数
- [ ] 2.5.4 实现 `stop_scheduler()` 函数
- [ ] 2.5.5 配置定时任务（每小时执行）
- [ ] 2.5.6 添加日志输出

### 2.6 优化市场分析器
- [ ] 2.6.1 修改 `analysis_service/analyzer.py`
- [ ] 2.6.2 确认 K 线数量固定为 2000
- [ ] 2.6.3 优化批量获取逻辑
- [ ] 2.6.4 添加限流处理
- [ ] 2.6.5 添加重试逻辑
- [ ] 2.6.6 优化错误处理

### 2.7 重构主程序
- [ ] 2.7.1 修改 `analysis_service/main.py`
- [ ] 2.7.2 移除 `POST /analyze` 端点
- [ ] 2.7.3 移除 `GET /results` 端点
- [ ] 2.7.4 保留 `GET /health` 端点
- [ ] 2.7.5 移除 `perform_analysis()` 函数
- [ ] 2.7.6 移除 FastAPI 路由相关代码
- [ ] 2.7.7 在 lifespan 中集成调度器启动
- [ ] 2.7.8 在 lifespan 中添加首次分析执行
- [ ] 2.7.9 添加优雅关闭逻辑

### 2.8 删除无用文件
- [ ] 2.8.1 删除 `analysis_service/schemas.py`
- [ ] 2.8.2 确认没有其他文件引用 schemas.py

### 2.9 更新依赖
- [ ] 2.9.1 修改 `analysis_service/requirements.txt`
- [ ] 2.9.2 添加 APScheduler 依赖
- [ ] 2.9.3 添加 tenacity 依赖（重试库）
- [ ] 2.9.4 确认所有依赖版本兼容

## 3. 配置和部署

### 3.1 更新 Docker Compose 配置
- [ ] 3.1.1 修改 `deploy/docker-compose.yml`
- [ ] 3.1.2 移除 analysis-service 的端口映射
- [ ] 3.1.3 移除 trading-assistant 的 ANALYSIS_SERVICE_URL
- [ ] 3.1.4 添加 analysis-service 环境变量
  - [ ] ANALYSIS_INTERVAL_HOURS=1
  - [ ] ANALYSIS_EXCHANGES=binance,bybit
  - [ ] ANALYSIS_TIMEFRAMES=1h,4h
  - [ ] ANALYSIS_KLINE_LIMIT=2000
  - [ ] ANALYSIS_RUN_ON_STARTUP=true
- [ ] 3.1.5 添加健康检查配置

### 3.2 更新环境变量配置
- [ ] 3.2.1 创建 `analysis_service/.env.example`
- [ ] 3.2.2 添加所有配置项说明
- [ ] 3.2.3 更新文档

### 3.3 更新 Dockerfile
- [ ] 3.3.1 确认 `analysis_service/Dockerfile` 配置正确
- [ ] 3.3.2 确认启动命令正确
- [ ] 3.3.3 优化镜像大小（如果需要）

## 4. 测试

### 4.1 单元测试
- [ ] 4.1.1 创建 `analysis_service/tests/` 目录
- [ ] 4.1.2 编写 `test_config.py` - 测试配置加载
- [ ] 4.1.3 编写 `test_symbol_fetcher.py` - 测试交易对获取
  - [ ] 测试 Binance 现货
  - [ ] 测试 Binance 期货
  - [ ] 测试 Bybit 现货
  - [ ] 测试 Bybit 期货
  - [ ] 测试 USDT 过滤
- [ ] 4.1.4 编写 `test_analyzer.py` - 测试分析逻辑
  - [ ] 测试支撑位计算
  - [ ] 测试压力位计算
  - [ ] 测试边界情况
- [ ] 4.1.5 编写 `test_db_manager.py` - 测试数据库操作
  - [ ] 测试插入
  - [ ] 测试更新
  - [ ] 测试 upsert

### 4.2 集成测试
- [ ] 4.2.1 编写 `test_integration.py`
- [ ] 4.2.2 测试完整分析流程
- [ ] 4.2.3 测试数据库写入
- [ ] 4.2.4 测试错误恢复

### 4.3 本地测试
- [ ] 4.3.1 本地启动 MySQL
- [ ] 4.3.2 配置本地环境变量
- [ ] 4.3.3 运行 Python 服务
- [ ] 4.3.4 验证首次分析执行
- [ ] 4.3.5 验证定时任务触发
- [ ] 4.3.6 检查数据库数据
- [ ] 4.3.7 检查日志输出

### 4.4 Docker 测试
- [ ] 4.4.1 构建 Python 服务镜像
- [ ] 4.4.2 使用 docker-compose 启动所有服务
- [ ] 4.4.3 验证服务启动顺序
- [ ] 4.4.4 验证首次分析执行
- [ ] 4.4.5 验证定时任务
- [ ] 4.4.6 验证 Go 后端 API 正常
- [ ] 4.4.7 验证前端页面正常

### 4.5 性能测试
- [ ] 4.5.1 测试单个交易对分析时间
- [ ] 4.5.2 测试完整分析总时间
- [ ] 4.5.3 测试内存使用情况
- [ ] 4.5.4 测试数据库连接池
- [ ] 4.5.5 验证性能指标符合要求（< 30 分钟）

## 5. 文档更新

### 5.1 更新 README
- [ ] 5.1.1 更新 `analysis_service/README.md`
- [ ] 5.1.2 说明新的架构设计
- [ ] 5.1.3 说明配置选项
- [ ] 5.1.4 说明启动流程
- [ ] 5.1.5 添加故障排查指南

### 5.2 更新部署文档
- [ ] 5.2.1 更新 `analysis_service/BUILD_GUIDE.md`
- [ ] 5.2.2 说明 Docker 构建步骤
- [ ] 5.2.3 说明环境变量配置
- [ ] 5.2.4 添加监控建议

### 5.3 更新 API 文档
- [ ] 5.3.1 更新主 README.md
- [ ] 5.3.2 说明分析服务不再提供 HTTP 接口
- [ ] 5.3.3 说明 Go 后端 API 保持不变

## 6. 部署上线

### 6.1 构建镜像
- [ ] 6.1.1 构建 Python 分析服务镜像
- [ ] 6.1.2 测试镜像启动
- [ ] 6.1.3 推送镜像到 Docker Hub

### 6.2 更新生产环境
- [ ] 6.2.1 备份当前配置
- [ ] 6.2.2 更新 docker-compose.yml
- [ ] 6.2.3 停止旧服务
- [ ] 6.2.4 启动新服务
- [ ] 6.2.5 验证服务运行正常

### 6.3 监控和验证
- [ ] 6.3.1 检查服务日志
- [ ] 6.3.2 验证首次分析完成
- [ ] 6.3.3 验证数据库数据
- [ ] 6.3.4 验证前端页面显示
- [ ] 6.3.5 监控 1 小时后的定时任务执行
- [ ] 6.3.6 监控 24 小时稳定性

## 7. 后续优化（可选）

### 7.1 添加监控指标
- [ ] 7.1.1 集成 Prometheus 客户端
- [ ] 7.1.2 暴露分析成功率指标
- [ ] 7.1.3 暴露分析耗时指标
- [ ] 7.1.4 暴露失败率指标

### 7.2 添加告警
- [ ] 7.2.1 配置告警规则
- [ ] 7.2.2 集成告警通知（邮件/Telegram）
- [ ] 7.2.3 测试告警触发

### 7.3 性能优化
- [ ] 7.3.1 优化并发数
- [ ] 7.3.2 优化数据库批量操作
- [ ] 7.3.3 添加缓存机制
- [ ] 7.3.4 优化 K 线获取逻辑

## 任务统计

- **总任务数**: 约 120 个
- **预计工作量**: 8-10 小时
- **关键路径**: 
  1. Python 服务重构 (4-5 小时)
  2. 测试验证 (2-3 小时)
  3. 部署上线 (1-2 小时)

## 优先级说明

- **P0 (必须)**: 任务 1, 2, 3, 4.3, 4.4, 6
- **P1 (重要)**: 任务 4.1, 4.2, 4.5, 5
- **P2 (可选)**: 任务 7
