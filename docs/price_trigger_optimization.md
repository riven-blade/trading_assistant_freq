# ä»·æ ¼è§¦å‘ä¼˜åŒ– - ä½¿ç”¨å®æ—¶ä¹°å–ä»·ä»£æ›¿æ ‡è®°ä»·æ ¼

## é—®é¢˜èƒŒæ™¯

### åŸæœ‰æ–¹æ¡ˆ
- **ä»·æ ¼æ¥æº**ï¼šåªä½¿ç”¨ `premiumIndex` æ¥å£è·å–æ ‡è®°ä»·æ ¼ï¼ˆmarkPriceï¼‰
- **é—®é¢˜**ï¼šæ ‡è®°ä»·æ ¼æ˜¯åŠ æƒå¹³å‡ä»·ï¼Œå»¶è¿Ÿè¾ƒé«˜ï¼Œä¸å¤Ÿå®æ—¶
- **å½±å“**ï¼šç›‘æ§è§¦å‘ä¸å¤Ÿç²¾å‡†ï¼Œå¯èƒ½é”™è¿‡æœ€ä½³äº¤æ˜“æ—¶æœº

### ä¼˜åŒ–æ–¹æ¡ˆ
- **ä»·æ ¼æ¥æº**ï¼š
  1. `ticker/24hr` æ¥å£è·å–å®æ—¶ä¹°å–ä»·ï¼ˆbid/askï¼‰- ä½œä¸º**è§¦å‘ä»·æ ¼**
  2. `premiumIndex` æ¥å£è·å–èµ„é‡‘è´¹ç‡ï¼ˆfundingRateï¼‰- ä½œä¸º**è¾…åŠ©åˆ¤æ–­**
- **ä¼˜åŠ¿**ï¼š
  - å®æ—¶æ€§æ›´é«˜ï¼ˆbid/ask æ˜¯å®æ—¶æœ€ä¼˜ä»·æ ¼ï¼‰
  - è§¦å‘æ›´ç²¾å‡†ï¼ˆä½¿ç”¨çœŸå®äº¤æ˜“ä»·æ ¼ï¼‰
  - å»¶è¿Ÿæ›´ä½

## ä¿®æ”¹å†…å®¹

### 1. æ•°æ®ç»“æ„ä¿®æ”¹

#### `pkg/exchanges/types/types.go`
```go
type WatchMarkPrice struct {
    Symbol               string  `json:"symbol"`
    TimeStamp            int64   `json:"timestamp"`
    MarkPrice            float64 `json:"mark_price"`             // æ ‡è®°ä»·æ ¼ï¼ˆä¿ç•™å…¼å®¹ï¼‰
    IndexPrice           float64 `json:"index_price"`            // æŒ‡æ•°ä»·æ ¼
    FundingRate          float64 `json:"funding_rate"`           // èµ„é‡‘è´¹ç‡
    FundingTime          int64   `json:"funding_time"`           // ä¸‹æ¬¡èµ„é‡‘è´¹æ—¶é—´
    EstimatedSettlePrice float64 `json:"estimated_settle_price"` 
    BidPrice             float64 `json:"bid_price"`              // âœ¨ æ–°å¢ï¼šæœ€ä¼˜ä¹°ä»·
    AskPrice             float64 `json:"ask_price"`              // âœ¨ æ–°å¢ï¼šæœ€ä¼˜å–ä»·
}
```

### 2. Redis å­˜å‚¨ä¿®æ”¹

#### `pkg/redis/markprice_operations.go`
- `SetMarkPrice`: æ–°å¢å­˜å‚¨ `bid_price` å’Œ `ask_price`
- `GetMarkPrice`: æ–°å¢è¯»å– `bid_price` å’Œ `ask_price`

### 3. ä»·æ ¼è·å–é€»è¾‘ä¿®æ”¹

#### `core/price_manager.go`

**åŸé€»è¾‘**ï¼š
```go
// åªè·å– premiumIndexï¼ˆ10æƒé‡ï¼‰
markPrices := pm.exchangeClient.FetchMarkPrices(ctx, selectedSymbols)
// é—®é¢˜ï¼šmarkPrice å»¶è¿Ÿé«˜ï¼Œä¸å¤Ÿå®æ—¶
```

**æ–°é€»è¾‘**ï¼š
```go
// 1. è·å–å®æ—¶BookTickerï¼ˆåªåŒ…å«bid/askï¼Œæƒé‡æ›´ä½ï¼‰
tickers := pm.exchangeClient.FetchBookTickers(ctx, selectedSymbols, nil)

// 2. è·å–èµ„é‡‘è´¹ç‡
markPrices := pm.exchangeClient.FetchMarkPrices(ctx, selectedSymbols)

// 3. åˆå¹¶æ•°æ®
watchMarkPrice := &types.WatchMarkPrice{
    BidPrice:    ticker.Bid,              // æ¥è‡ª bookTicker
    AskPrice:    ticker.Ask,              // æ¥è‡ª bookTicker
    MarkPrice:   markPrice.MarkPrice,     // æ¥è‡ª premiumIndex
    FundingRate: markPrice.FundingRate,   // æ¥è‡ª premiumIndex
}
```

### 4. è§¦å‘é€»è¾‘ä¿®æ”¹

#### `core/monitor_core.go`

**åŸé€»è¾‘**ï¼š
```go
// ç»Ÿä¸€ä½¿ç”¨æ ‡è®°ä»·æ ¼
currentPrice := markPriceData.MarkPrice
```

**æ–°é€»è¾‘**ï¼š
```go
// æ ¹æ®äº¤æ˜“æ–¹å‘é€‰æ‹©åˆé€‚çš„å®æ—¶ä»·æ ¼
if estimate.Side == types.PositionSideLong {
    currentPrice = markPriceData.AskPrice  // åšå¤šç”¨å–ä»·ï¼ˆä¹°å…¥æˆæœ¬ï¼‰
} else if estimate.Side == types.PositionSideShort {
    currentPrice = markPriceData.BidPrice  // åšç©ºç”¨ä¹°ä»·ï¼ˆå–å‡ºä»·æ ¼ï¼‰
}

// é™çº§ç­–ç•¥ï¼šå¦‚æœ bid/ask æ— æ•ˆï¼Œä½¿ç”¨æ ‡è®°ä»·æ ¼
if currentPrice <= 0 {
    currentPrice = markPriceData.MarkPrice
}
```

## ä»·æ ¼é€‰æ‹©é€»è¾‘

### åšå¤šï¼ˆLongï¼‰åœºæ™¯
- **ä½¿ç”¨ä»·æ ¼**ï¼šAskPriceï¼ˆå–ä»·ï¼‰
- **åŸå› **ï¼šå¼€å¤šä»“éœ€è¦ä¹°å…¥ï¼Œå…³æ³¨å–æ–¹æŒ‚å•ä»·æ ¼
- **ç¤ºä¾‹**ï¼š
  - å½“å‰ Ask = 50,000
  - ç›®æ ‡ä»· = 49,500ï¼ˆè·Œç ´è§¦å‘ï¼‰
  - Ask <= 49,500 æ—¶è§¦å‘

### åšç©ºï¼ˆShortï¼‰åœºæ™¯
- **ä½¿ç”¨ä»·æ ¼**ï¼šBidPriceï¼ˆä¹°ä»·ï¼‰
- **åŸå› **ï¼šå¼€ç©ºä»“éœ€è¦å–å‡ºï¼Œå…³æ³¨ä¹°æ–¹æŒ‚å•ä»·æ ¼
- **ç¤ºä¾‹**ï¼š
  - å½“å‰ Bid = 51,000
  - ç›®æ ‡ä»· = 51,500ï¼ˆçªç ´è§¦å‘ï¼‰
  - Bid >= 51,500 æ—¶è§¦å‘

### èµ„é‡‘è´¹ç‡æ£€æŸ¥
- **ä»…åšç©ºæ—¶æ£€æŸ¥**
- **æ•°æ®æ¥æº**ï¼š`premiumIndex` æ¥å£çš„ `fundingRate` å­—æ®µ
- **é€»è¾‘**ï¼šèµ„é‡‘è´¹ç‡ < é…ç½®é˜ˆå€¼æ—¶ï¼Œæ‹’ç»è§¦å‘

## API è°ƒç”¨åˆ†æ

### æ¥å£è°ƒç”¨ï¼ˆ1ç§’/æ¬¡ï¼‰
```
æ¯ç§’è°ƒç”¨ï¼š
â”œâ”€ /fapi/v1/ticker/bookTicker (å…¨å¸‚åœº)  - æƒé‡: 5
â””â”€ /fapi/v1/premiumIndex (å…¨å¸‚åœº)       - æƒé‡: 10
æ€»è®¡: 15æƒé‡/ç§’

æ¯åˆ†é’Ÿæƒé‡ï¼š
15æƒé‡/ç§’ Ã— 60ç§’ = 900æƒé‡/åˆ†é’Ÿ âœ…
```

### é™é€Ÿåˆ†æ
```
Binance æœŸè´§é™åˆ¶ï¼š
- IPé™åˆ¶ï¼š2400æƒé‡/åˆ†é’Ÿ
- UIDé™åˆ¶ï¼š1200æƒé‡/åˆ†é’Ÿ

å®é™…æ¶ˆè€—ï¼ˆå…¨å¸‚åœºï¼‰ï¼š
- bookTicker: 5æƒé‡ Ã— 60 = 300æƒé‡/åˆ†é’Ÿ
- premiumIndex: 10æƒé‡ Ã— 60 = 600æƒé‡/åˆ†é’Ÿ
- æ€»è®¡: 900æƒé‡/åˆ†é’Ÿ âœ… å®‰å…¨

âœ… ä½¿ç”¨ bookTicker çš„ä¼˜åŠ¿ï¼š
1. æƒé‡ä½ï¼ˆ5 vs 40ï¼‰- èŠ‚çœ 87.5% æƒé‡
2. æ•°æ®è½»é‡ï¼ˆåªæœ‰ bid/askï¼Œä¸åŒ…å«24hç»Ÿè®¡ï¼‰
3. å“åº”å¿«ï¼ˆæ•°æ®é‡å°ï¼‰
4. å……è¶³ä½™é‡ï¼ˆå ç”¨ 75% UID é…é¢ï¼Œ25% IP é…é¢ï¼‰
```

### ä¼˜åŒ–å»ºè®®

#### æ–¹æ¡ˆAï¼šåªè¯·æ±‚é€‰ä¸­äº¤æ˜“å¯¹ï¼ˆå¯è¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰
```go
// å¦‚æœåªç›‘æ§ 10 ä¸ªäº¤æ˜“å¯¹
symbols := []string{"BTCUSDT", "ETHUSDT", ...}

// bookTicker: 2æƒé‡ Ã— 10 = 20æƒé‡
// premiumIndex: 1æƒé‡ Ã— 10 = 10æƒé‡
// æ€»è®¡: 30æƒé‡/ç§’ = 1800æƒé‡/åˆ†é’Ÿ
// è™½ç„¶è¶…é™ï¼Œä½†å¦‚æœäº¤æ˜“å¯¹å°‘ï¼Œå¯ä»¥é™åˆ°å®‰å…¨èŒƒå›´
```

#### æ–¹æ¡ˆBï¼šå½“å‰æ–¹æ¡ˆï¼ˆå…¨å¸‚åœº + bookTickerï¼‰âœ… æ¨è
```go
// ä½¿ç”¨ bookTicker æ›¿ä»£ ticker/24hr
// 900æƒé‡/åˆ†é’Ÿï¼Œå®‰å…¨ä¸”ç¨³å®š
// é€‚åˆç›‘æ§æ‰€æœ‰äº¤æ˜“å¯¹çš„åœºæ™¯
```

## æ•°æ®æµå‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Binance API                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bookTicker      â”‚  premiumIndex                         â”‚
â”‚ - bidPrice      â”‚  - markPrice                          â”‚
â”‚ - askPrice      â”‚  - fundingRate                        â”‚
â”‚ - bidQty        â”‚  - indexPrice                         â”‚
â”‚ - askQty        â”‚  - nextFundingTime                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PriceManager.fetchPricesOnce()                          â”‚
â”‚ - åˆå¹¶ ticker å’Œ markPrice æ•°æ®                          â”‚
â”‚ - æ„å»º WatchMarkPrice ç»“æ„                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redis Cache                                             â”‚
â”‚ Key: mark_price:BTCUSDT                                 â”‚
â”‚ - bid_price: 50000.0                                    â”‚
â”‚ - ask_price: 50001.0                                    â”‚
â”‚ - mark_price: 50000.5                                   â”‚
â”‚ - funding_rate: 0.0001                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PriceMonitor.checkSingleEstimate()                      â”‚
â”‚ - Long: ä½¿ç”¨ askPrice åˆ¤æ–­è§¦å‘                           â”‚
â”‚ - Short: ä½¿ç”¨ bidPrice + fundingRate åˆ¤æ–­                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é™çº§ç­–ç•¥

### æ•°æ®ç¼ºå¤±å¤„ç†
1. **Ticker æ•°æ®ç¼ºå¤±**
   - ä½¿ç”¨ `markPrice.MarkPrice` ä½œä¸º bid/ask
   
2. **MarkPrice æ•°æ®ç¼ºå¤±**
   - ä½¿ç”¨ `ticker.Last` ä½œä¸º markPrice
   - èµ„é‡‘è´¹ç‡æ£€æŸ¥è·³è¿‡

3. **ä¸¤è€…éƒ½æœ‰æ•ˆ**
   - bid/ask ä» ticker
   - fundingRate ä» markPrice
   - æœ€ä½³æƒ…å†µ

### ä»·æ ¼éªŒè¯
```go
// éªŒè¯é€»è¾‘
if watchMarkPrice.BidPrice <= 0 || watchMarkPrice.AskPrice <= 0 {
    logrus.Warn("ä¹°å–ä»·æ— æ•ˆï¼Œè·³è¿‡è¯¥å¸ç§")
    continue
}
```

## å‰ç«¯å¹¿æ’­æ•°æ®

```json
{
  "symbol": "BTCUSDT",
  "bidPrice": 50000.0,        // âœ¨ æ–°å¢
  "askPrice": 50001.0,        // âœ¨ æ–°å¢
  "markPrice": 50000.5,       // ä¿ç•™
  "indexPrice": 50000.3,
  "fundingRate": 0.0001,
  "fundingTime": 1234567890,
  "updateTime": 1234567890,
  "priceChange": 100.5,
  "priceChangePercent": 0.2
}
```

## æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯• bid/ask ä»·æ ¼å­˜å‚¨å’Œè¯»å–
- [ ] æµ‹è¯•ä»·æ ¼é€‰æ‹©é€»è¾‘ï¼ˆlongç”¨askï¼Œshortç”¨bidï¼‰
- [ ] æµ‹è¯•é™çº§ç­–ç•¥

### 2. é›†æˆæµ‹è¯•
- [ ] æµ‹è¯•ä¸¤ä¸ªæ¥å£åŒæ—¶è°ƒç”¨
- [ ] æµ‹è¯•æ•°æ®åˆå¹¶é€»è¾‘
- [ ] æµ‹è¯•é™é€Ÿä¿æŠ¤

### 3. ç›‘æ§æŒ‡æ ‡
- [ ] APIè°ƒç”¨æˆåŠŸç‡
- [ ] æƒé‡ä½¿ç”¨æƒ…å†µ
- [ ] è§¦å‘ç²¾å‡†åº¦ï¼ˆä¸å®é™…æˆäº¤ä»·å¯¹æ¯”ï¼‰
- [ ] å»¶è¿Ÿï¼ˆä»ä»·æ ¼æ›´æ–°åˆ°è§¦å‘çš„æ—¶é—´ï¼‰

## ç‰ˆæœ¬å†å²

- **v1.0** - 2025-01-16
  - åˆå§‹å®ç°
  - æ·»åŠ  bid/ask ä»·æ ¼æ”¯æŒ
  - ä¼˜åŒ–è§¦å‘é€»è¾‘
  - ä¿ç•™å‘åå…¼å®¹æ€§

## åç»­ä¼˜åŒ–æ–¹å‘

1. **WebSocket æ–¹æ¡ˆ**
   - ä½¿ç”¨ `@bookTicker` æµè·å–å®æ—¶ä¹°å–ä»·
   - ä½¿ç”¨ `@markPrice` æµè·å–èµ„é‡‘è´¹ç‡
   - æ— é™é€Ÿé™åˆ¶ï¼Œå»¶è¿Ÿæ›´ä½

2. **æ™ºèƒ½é™çº§**
   - æ ¹æ®é™é€Ÿæƒ…å†µè‡ªåŠ¨è°ƒæ•´é¢‘ç‡
   - æ ¹æ®å¸‚åœºæ³¢åŠ¨è°ƒæ•´æ›´æ–°é¢‘ç‡

3. **ä»·æ ¼æ»‘ç‚¹ä¿æŠ¤**
   - è®¡ç®— bid-ask spread
   - æ»‘ç‚¹è¿‡å¤§æ—¶å‘å‡ºé¢„è­¦

---

## ğŸ“Š API æƒé‡è¯¦ç»†å¯¹æ¯”

| æ¥å£ | æƒé‡ï¼ˆå…¨å¸‚åœºï¼‰ | æƒé‡ï¼ˆå•ä¸ªï¼‰ | åŒ…å«æ•°æ® | æ¨èåœºæ™¯ |
|------|---------------|-------------|----------|---------|
| **bookTicker** âœ… | 5 | 2 | bid/askä»·æ ¼å’Œæ•°é‡ | **å®æ—¶ç›‘æ§è§¦å‘** |
| ticker/24hr | 40 | 1-2 | bid/ask + 24hç»Ÿè®¡ | éœ€è¦24hæ•°æ® |
| premiumIndex | 10 | 1 | æ ‡è®°ä»·æ ¼+èµ„é‡‘è´¹ç‡ | **èµ„é‡‘è´¹ç‡** |

### å½“å‰æ–¹æ¡ˆæƒé‡æ¶ˆè€—ï¼ˆ1ç§’/æ¬¡ï¼‰

```
bookTicker:    5æƒé‡ Ã— 60ç§’ = 300æƒé‡/åˆ†é’Ÿ
premiumIndex: 10æƒé‡ Ã— 60ç§’ = 600æƒé‡/åˆ†é’Ÿ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:                        900æƒé‡/åˆ†é’Ÿ

Binanceé™åˆ¶:
- UIDé™åˆ¶: 1200æƒé‡/åˆ†é’Ÿ
- ä½¿ç”¨ç‡: 900/1200 = 75% âœ…
- ä½™é‡: 300æƒé‡/åˆ†é’Ÿï¼ˆå¯ç”¨äºå…¶ä»–APIï¼‰
```

---

**ä¿®æ”¹å®Œæˆæ—¶é—´**: 2025-01-16  
**æµ‹è¯•çŠ¶æ€**: âœ… ç¼–è¯‘é€šè¿‡ï¼ˆå·²ä½¿ç”¨ bookTickerï¼‰  
**ç”Ÿäº§å°±ç»ª**: å¾…æµ‹è¯•

